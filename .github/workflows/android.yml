name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Setup SDL2 Project
      run: |
        # 1. Download SDL2
        wget https://github.com/libsdl-org/SDL/releases/download/release-2.30.0/SDL2-2.30.0.zip
        unzip -q SDL2-2.30.0.zip
        
        # 2. Setup Project Structure
        mv SDL2-2.30.0/android-project .
        mv SDL2-2.30.0 SDL
        
        # 3. Move files to JNI
        mkdir -p android-project/app/src/main/jni
        mv SDL android-project/app/src/main/jni/
        
        # 4. Setup Source
        mkdir -p android-project/app/src/main/jni/src
        cp main.cpp android-project/app/src/main/jni/src/
        
    - name: Create Build Scripts
      run: |
        cd android-project/app/src/main/jni
        
        # Create the Master Android.mk
        # We write the content using a heredoc to ensure formatting is perfect.
        # We escape $ signs so bash writes them literally to the file.
        
        cat <<EOF > Android.mk
        LOCAL_PATH := \$(call my-dir)
        
        # --- 1. Include SDL2 Definition ---
        include \$(LOCAL_PATH)/SDL/Android.mk
        
        # --- 2. Define Game Module ---
        include \$(CLEAR_VARS)
        
        LOCAL_MODULE := main
        
        # Path to SDL headers
        LOCAL_C_INCLUDES := \$(LOCAL_PATH)/SDL/include
        
        # Source files: SDL main wrapper + your game code
        # Note: We point to SDL_android_main.c inside the SDL folder
        LOCAL_SRC_FILES := SDL/src/main/android/SDL_android_main.c src/main.cpp
        
        # Link against SDL2 (Defined in step 1)
        LOCAL_SHARED_LIBRARIES := SDL2
        
        # Link OpenGL and Log
        LOCAL_LDLIBS := -lGLESv1_CM -lGLESv2 -llog
        
        include \$(BUILD_SHARED_LIBRARY)
        EOF
        
        # Create Application.mk
        cat <<EOF > Application.mk
        APP_ABI := arm64-v8a
        APP_STL := c++_shared
        APP_PLATFORM := android-21
        EOF

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Uphill-Game-APK
        path: android-project/app/build/outputs/apk/debug/app-debug.apk
