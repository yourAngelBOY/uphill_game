name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Setup SDL2 Project
      run: |
        # 1. Download SDL2 (Base only)
        wget https://github.com/libsdl-org/SDL/releases/download/release-2.30.0/SDL2-2.30.0.zip
        unzip -q SDL2-2.30.0.zip
        
        # 2. Setup Project Structure
        mv SDL2-2.30.0/android-project .
        mv SDL2-2.30.0 SDL
        
        # 3. Move files to JNI
        mkdir -p android-project/app/src/main/jni
        mv SDL android-project/app/src/main/jni/
        
        # 4. Setup Source
        mkdir -p android-project/app/src/main/jni/src
        cp main.cpp android-project/app/src/main/jni/src/
        
    - name: Sanitize Source Code
      run: |
        # Remove Image and Mixer includes because we haven't installed those libraries yet.
        # Chunk 1 doesn't use them, so we can safely remove the headers to prevent build errors.
        cd android-project/app/src/main/jni/src
        sed -i 's/#include <SDL2\/SDL_image.h>//g' main.cpp
        sed -i 's/#include <SDL2\/SDL_mixer.h>//g' main.cpp
        
        # Fix include path: SDL2/SDL.h -> SDL.h (Android NDK pathing difference)
        sed -i 's/#include <SDL2\/SDL.h>/#include <SDL.h>/g' main.cpp

    - name: Create Build Scripts
      run: |
        cd android-project/app/src/main/jni
        
        # Create a robust Android.mk that handles paths correctly
        cat <<EOF > Android.mk
        LOCAL_PATH := \$(call my-dir)
        
        # --- 1. Include SDL2 ---
        # We explicitly include the SDL2 makefile. 
        # Note: This changes LOCAL_PATH to point to the SDL directory.
        include \$(LOCAL_PATH)/SDL/Android.mk
        
        # --- 2. Build Game ---
        include \$(CLEAR_VARS)
        
        LOCAL_MODULE := main
        
        # Reset LOCAL_PATH to the JNI root because the previous include changed it
        LOCAL_PATH := \$(call my-dir)
        
        LOCAL_C_INCLUDES := \$(LOCAL_PATH)/SDL/include
        
        # Define source files. 
        # SDL_android_main.c is required to launch the app.
        LOCAL_SRC_FILES := SDL/src/main/android/SDL_android_main.c \
                           src/main.cpp
        
        LOCAL_SHARED_LIBRARIES := SDL2
        LOCAL_LDLIBS := -lGLESv1_CM -lGLESv2 -llog
        
        include \$(BUILD_SHARED_LIBRARY)
        EOF
        
        # Create Application.mk
        cat <<EOF > Application.mk
        APP_ABI := arm64-v8a
        APP_STL := c++_shared
        APP_PLATFORM := android-21
        EOF

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Uphill-Game-APK
        path: android-project/app/build/outputs/apk/debug/app-debug.apk
