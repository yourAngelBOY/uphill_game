name: Build Android APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Setup SDL2 Project
      run: |
        # 1. Download SDL2
        wget https://github.com/libsdl-org/SDL/releases/download/release-2.30.0/SDL2-2.30.0.zip
        unzip -q SDL2-2.30.0.zip
        
        # 2. Move the Android Project template out to the root
        mv SDL2-2.30.0/android-project .
        
        # 3. Rename the remaining source folder to 'SDL'
        mv SDL2-2.30.0 SDL
        
        # 4. Move the SDL source folder into the JNI directory
        mkdir -p android-project/app/src/main/jni
        mv SDL android-project/app/src/main/jni/
        
        # 5. Setup the 'src' directory for your main.cpp
        mkdir -p android-project/app/src/main/jni/src
        
        # 6. Copy your game code
        cp main.cpp android-project/app/src/main/jni/src/
        
    - name: Configure Build Files
      run: |
        # --- STEP 1: Create the Game Module Makefile ---
        cd android-project/app/src/main/jni/src
        
        echo 'LOCAL_PATH := $(call my-dir)' > Android.mk
        echo 'include $(CLEAR_VARS)' >> Android.mk
        echo 'LOCAL_MODULE := main' >> Android.mk
        echo 'SDL_PATH := ../SDL' >> Android.mk
        echo 'LOCAL_C_INCLUDES := $(LOCAL_PATH)/$(SDL_PATH)/include' >> Android.mk
        
        # IMPORTANT: We must compile SDL_android_main.c alongside main.cpp
        echo 'LOCAL_SRC_FILES := $(SDL_PATH)/src/main/android/SDL_android_main.c main.cpp' >> Android.mk
        
        echo 'LOCAL_SHARED_LIBRARIES := SDL2' >> Android.mk
        echo 'LOCAL_LDLIBS := -lGLESv1_CM -lGLESv2 -llog' >> Android.mk
        echo 'include $(BUILD_SHARED_LIBRARY)' >> Android.mk
        
        # --- STEP 2: Overwrite the Root Makefile to include subdirs ---
        cd ..
        echo 'LOCAL_PATH := $(call my-dir)' > Android.mk
        echo 'include $(call all-subdir-makefiles)' >> Android.mk
        
        # --- STEP 3: Create Application.mk ---
        echo 'APP_ABI := arm64-v8a' > Application.mk
        echo 'APP_STL := c++_shared' >> Application.mk
        echo 'APP_PLATFORM := android-21' >> Application.mk

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Uphill-Game-APK
        path: android-project/app/build/outputs/apk/debug/app-debug.apk
